<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Dashboard</title>
    <style>
        /* CSS is unchanged */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap');
        body{font-family:'Poppins',sans-serif;background-color:#f4f7f6;margin:0;padding:20px}.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}.header h1{color:#333}.add-request-btn{background-color:#007bff;color:white;border:none;border-radius:50px;padding:10px 20px;font-size:16px;cursor:pointer;display:flex;align-items:center;gap:8px;transition:background-color .3s}.add-request-btn:hover{background-color:#0056b3}.add-request-btn .plus-icon{font-size:20px;font-weight:700}.main-content{background-color:white;padding:20px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,.1)}.filters{margin-bottom:20px;display:flex;gap:15px}.filters input{padding:10px;border:1px solid #ddd;border-radius:4px;width:250px}.orders-table{width:100%;border-collapse:collapse}.orders-table th,.orders-table td{padding:12px;border-bottom:1px solid #eee;text-align:left}.orders-table th{background-color:#f8f9fa;font-weight:600}.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:none;justify-content:center;align-items:center;z-index:1000}.modal-content{background:white;padding:30px;border-radius:8px;width:90%;max-width:500px;position:relative}.modal-content h2{margin-top:0}.close-btn{position:absolute;top:15px;right:15px;font-size:24px;cursor:pointer;border:none;background:none}.form-group{margin-bottom:15px}.form-group label{display:block;margin-bottom:5px;font-weight:500}.form-group input,.form-group select{width:100%;padding:10px;border:1px solid #ccc;border-radius:4px}
        .submit-btn{width:100%;padding:12px;background-color:#28a745;color:white;border:none;border-radius:4px;cursor:pointer;font-size:16px;transition: background-color 0.3s ease;}
        .submit-btn:hover{background-color:#218838}
        /* --- CHANGE --- Style for the disabled button */
        .submit-btn:disabled {
            background-color: #9c9c9c;
            cursor: not-allowed;
        }
    </style>
</head>
<body>

    <div class="header">
        <h1>My Sales Requests</h1>
        <button class="add-request-btn" id="addRequestBtn"><span class="plus-icon">+</span> Add Request</button>
    </div>

    <div class="main-content">
        <div class="filters">
            <input type="text" id="filterInput" onkeyup="filterTable()" placeholder="Filter by Item Name or Vender...">
        </div>
        <table class="orders-table">
            <thead>
                <tr>
                    <th>UniqueID</th><th>Timestamp</th><th>Vender Name</th><th>Item Name</th><th>Qty</th><th>Godown Location</th><th>Order Status</th>
                </tr>
            </thead>
            <tbody id="ordersTableBody">
                <!-- Data will be loaded here -->
            </tbody>
        </table>
    </div>

    <div class="modal-overlay" id="requestModal">
        <div class="modal-content">
            <button class="close-btn" id="closeModalBtn">&times;</button>
            <h2>New Sales Request</h2>
            <form id="salesRequestForm">
                <div class="form-group">
                    <label for="venderName">Vender Name</label>
                    <select id="venderName" required>
                        <option value="">Loading Venders...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="itemName">Item Name</label>
                    <select id="itemName" required>
                        <option value="">Loading Items...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="qty">Quantity</label>
                    <input type="number" id="qty" required>
                </div>
                <div class="form-group">
                    <label for="godownLocation">Godown Location</label>
                    <select id="godownLocation" required>
                        <option value="">Select Location</option>
                        <option value="Main-A">Main-A</option>
                        <option value="Warehouse-B">Warehouse-B</option>
                        <option value="Stockroom-C">Stockroom-C</option>
                    </select>
                </div>
                <button type="submit" class="submit-btn">Submit Request</button>
            </form>
        </div>
    </div>

    <script>
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbz4rczYSc6x5iWNflvYVWEv6qVWgkFQeTOKCbWekhllKDh6N_xWVeRGP_-CpQAQYSHRXw/exec';

        document.addEventListener('DOMContentLoaded', function() {
            if (sessionStorage.getItem("userType") !== "Sales Team") {
                window.location.href = "Index.html";
                return;
            }
            fetchDropdownData();
            fetchUserOrders();
        });
        
        // --- FORM SUBMISSION ---
        document.getElementById('salesRequestForm').addEventListener('submit', function(e) {
            e.preventDefault(); // Prevent default form submission

            // --- CHANGE --- Get the submit button from inside the form
            const submitButton = this.querySelector('.submit-btn');

            const orderData = {
                user: sessionStorage.getItem("userEmail"),
                venderName: document.getElementById('venderName').value,
                itemName: document.getElementById('itemName').value,
                qty: document.getElementById('qty').value,
                godownLocation: document.getElementById('godownLocation').value
            };
            
            const postData = {
                action: "addOrder",
                orderData: orderData
            };
            
            // --- CHANGE --- Disable button and show submitting text
            submitButton.disabled = true;
            submitButton.innerText = 'Submitting...';

            fetch(WEB_APP_URL, {
                method: 'POST',
                body: JSON.stringify(postData),
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert(data.message);
                    modal.style.display = 'none'; // Hide modal
                    this.reset(); // Reset form fields
                    fetchUserOrders(); // Refresh the table with the new order
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            })
            .finally(() => {
                // --- CHANGE --- This block runs on success OR failure
                // Re-enable the button and reset its text
                submitButton.disabled = false;
                submitButton.innerText = 'Submit Request';
            });
        });


        // --- ALL OTHER JAVASCRIPT FUNCTIONS (fetchDropdownData, fetchUserOrders, etc.) ---
        // --- ARE THE SAME AS BEFORE. No changes needed for the rest of the script. ---

        function fetchDropdownData(){fetch(`${WEB_APP_URL}?action=getDropdownData`).then(response=>response.json()).then(response=>{if(response.status==='success'){populateDropdown('venderName',response.data.venders,'Select Vender');populateDropdown('itemName',response.data.items,'Select Item')}else{alert('Error fetching dropdown data: '+response.message)}}).catch(error=>console.error('Error fetching dropdown data:',error))}
        function populateDropdown(selectId,optionsArray,defaultText){const select=document.getElementById(selectId);select.innerHTML=`<option value="">${defaultText}</option>`;optionsArray.forEach(optionValue=>{const option=document.createElement('option');option.value=optionValue;option.textContent=optionValue;select.appendChild(option)})}
        function fetchUserOrders(){const userEmail=sessionStorage.getItem("userEmail");if(!userEmail)return;fetch(`${WEB_APP_URL}?user=${encodeURIComponent(userEmail)}`).then(response=>response.json()).then(data=>{if(data.status==='success'){populateTable(data.data)}else{alert('Error fetching orders: '+data.message)}}).catch(error=>console.error('Error:',error))}
        function populateTable(orders){const tableBody=document.getElementById('ordersTableBody');tableBody.innerHTML='';orders.forEach(order=>{const row=`<tr><td>${order.uniqueID}</td><td>${order.timestamp}</td><td>${order.venderName}</td><td>${order.itemName}</td><td>${order.qty}</td><td>${order.godownLocation}</td><td>${order.orderStatus}</td></tr>`;tableBody.innerHTML+=row})}
        const modal=document.getElementById('requestModal'),addRequestBtn=document.getElementById('addRequestBtn'),closeModalBtn=document.getElementById('closeModalBtn');addRequestBtn.onclick=()=>{modal.style.display='flex'};closeModalBtn.onclick=()=>{modal.style.display='none'};window.onclick=event=>{if(event.target==modal){modal.style.display='none'}};
        function filterTable(){const filter=document.getElementById('filterInput').value.toUpperCase(),tableBody=document.getElementById('ordersTableBody'),rows=tableBody.getElementsByTagName('tr');for(let i=0;i<rows.length;i++){const venderCell=rows[i].getElementsByTagName('td')[2],itemCell=rows[i].getElementsByTagName('td')[3];if(venderCell||itemCell){const venderText=venderCell.textContent||venderCell.innerText,itemText=itemCell.textContent||itemCell.innerText;if(venderText.toUpperCase().indexOf(filter)>-1||itemText.toUpperCase().indexOf(filter)>-1){rows[i].style.display=""}else{rows[i].style.display="none"}}}}
    </script>

</body>
</html>