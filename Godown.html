<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Godown Dashboard</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap');
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f4f7f6;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .main-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .top-filters {
            display: flex;
            flex-wrap: wrap; /* Allows filters to stack on small screens */
            gap: 20px;
            margin-bottom: 20px;
            align-items: center;
        }
        .top-filters label {
            font-weight: 500;
        }
        .top-filters select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        
        /* --- DESKTOP TABLE STYLES --- */
        .orders-table {
            width: 100%;
            border-collapse: collapse;
        }
        .orders-table thead {
            background-color: #f8f9fa;
        }
        .orders-table th, .orders-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
            text-align: left;
            font-size: 14px;
        }
        .orders-table th {
            font-weight: 600;
        }
        .orders-table tbody tr:hover {
            background-color: #f8f9fa;
            cursor: pointer;
        }
        .update-btn {
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .update-btn:hover {
            background-color: #0056b3;
        }
        
        /* --- MODAL STYLES --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            position: relative;
        }
        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            border: none;
            background: none;
        }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-group select, .form-group textarea, .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: 'Poppins', sans-serif;
        }
        .submit-btn {
            width: 100%;
            padding: 12px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .submit-btn:disabled {
            background-color: #9c9c9c;
            cursor: not-allowed;
        }
        #orderIdDisplay, #historyOrderIdDisplay {
            font-weight: 600;
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .hidden {
            display: none;
        }
        #historyModal .modal-content {
            max-width: 600px;
        }
        .timeline { list-style: none; padding: 0; position: relative; }
        .timeline::before { content: ''; position: absolute; top: 0; bottom: 0; left: 10px; width: 3px; background-color: #e9ecef; }
        .timeline-item { margin-bottom: 20px; padding-left: 30px; position: relative; }
        .timeline-dot { position: absolute; left: 0; top: 4px; width: 22px; height: 22px; border-radius: 50%; background-color: #007bff; border: 3px solid white; }
        .timeline-date { font-size: 13px; color: #6c757d; margin-bottom: 5px; }
        .timeline-content { background-color: #f8f9fa; padding: 15px; border-radius: 6px; }

        /* --- NEW: RESPONSIVE CARD VIEW FOR MOBILE --- */
        @media (max-width: 768px) {
            .orders-table thead {
                display: none; /* Hide the table header on mobile */
            }
            .orders-table, .orders-table tbody, .orders-table tr, .orders-table td {
                display: block; /* Make table elements behave like divs */
                width: 100%;
            }
            .orders-table tr {
                margin-bottom: 15px;
                border: 1px solid #ddd;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                overflow: hidden;
            }
            .orders-table td {
                text-align: right; /* Align value to the right */
                padding-left: 50%; /* Create space for the label */
                position: relative;
                border-bottom: 1px solid #eee;
            }
            .orders-table td:last-child {
                border-bottom: none;
            }
            .orders-table td::before {
                content: attr(data-label);
                position: absolute;
                left: 12px;
                width: calc(50% - 24px);
                text-align: left;
                font-weight: 500;
                color: #333;
            }
            .action-cell {
                padding-left: 12px;
                text-align: center;
                background-color: #f8f9fa;
            }
            .action-cell .update-btn {
                width: 100%;
                padding: 10px;
            }
            .action-cell::before {
                content: ""; /* Hide label for the action button */
            }
        }
    </style>
</head>
<body>

    <div class="header">
        <h1>Godown Order Management</h1>
    </div>

    <div class="main-content">
        <div class="top-filters">
            <div>
                <label for="locationFilter">Filter by Location:</label>
                <select id="locationFilter" onchange="filterTable()">
                    <option value="">All Locations</option>
                    <option value="Main-A">Main-A</option>
                    <option value="Warehouse-B">Warehouse-B</option>
                    <option value="Stockroom-C">Stockroom-C</option>
                </select>
            </div>
            <div>
                <label for="statusFilter">Filter by Status:</label>
                <select id="statusFilter" onchange="filterTable()">
                    <option value="">All Statuses</option>
                    <option value="New">New</option>
                    <option value="Order Received">Order Received</option>
                    <option value="Dispatch">Dispatch</option>
                    <option value="Delivered">Delivered</option>
                    <option value="Cancel">Cancel</option>
                    <option value="Reject">Reject</option>
                </select>
            </div>
        </div>
        <table class="orders-table">
            <thead>
                <tr><th>UniqueID</th><th>Timestamp</th><th>Item Name</th><th>Qty</th><th>Location</th><th>Status</th><th>Action</th></tr>
            </thead>
            <tbody id="ordersTableBody"></tbody>
        </table>
    </div>

    <div class="modal-overlay" id="updateModal">
        <div class="modal-content">
            <button class="close-btn" id="closeModalBtn">&times;</button>
            <h2>Update Order Status</h2>
            <div id="orderIdDisplay"></div>
            <form id="updateOrderForm">
                <input type="hidden" id="updateUniqueID">
                <div class="form-group">
                    <label for="newStatus">New Status</label>
                    <select id="newStatus" required><option value="">Select new status</option><option value="Order Received">Order Received</option><option value="Dispatch">Dispatch</option><option value="Delivered">Delivered</option><option value="Cancel">Cancel</option><option value="Reject">Reject</option></select>
                </div>
                <div class="form-group hidden" id="remarkGroup"><label for="remark">Remark</label><textarea id="remark" rows="3"></textarea></div>
                <div class="form-group hidden" id="invoiceGroup"><label for="invoiceFile">Upload Invoice</label><input type="file" id="invoiceFile" accept=".pdf,.jpg,.jpeg,.png"></div>
                <button type="submit" class="submit-btn">Update Status</button>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="historyModal">
        <div class="modal-content">
            <button class="close-btn" id="closeHistoryModalBtn">&times;</button>
            <h2>Order History</h2>
            <div id="historyOrderIdDisplay"></div>
            <div id="historyTimelineContainer"></div>
        </div>
    </div>

    <script>
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbz4rczYSc6x5iWNflvYVWEv6qVWgkFQeTOKCbWekhllKDh6N_xWVeRGP_-CpQAQYSHRXw/exec';
        let allOrdersData = [];

        document.addEventListener('DOMContentLoaded', function() {
            if (sessionStorage.getItem("userType") !== "Godown Team") {
                window.location.href = "Index.html";
                return;
            }
            fetchAllOrders();
        });

        function fetchAllOrders() {
            fetch(`${WEB_APP_URL}?action=getAllOrders`)
                .then(response => response.json())
                .then(result => {
                    if (result.status === 'success') {
                        allOrdersData = result.data;
                        filterTable();
                    } else {
                        alert('Error fetching orders: ' + result.message);
                    }
                }).catch(err => console.error("Fetch Error:", err));
        }

        function populateTable(orders) {
            const tableBody = document.getElementById('ordersTableBody');
            tableBody.innerHTML = '';
            orders.forEach(order => {
                const row = document.createElement('tr');
                row.setAttribute('onclick', `openHistoryModal('${order.uniqueID}')`);
                row.innerHTML = `
                    <td data-label="UniqueID">${order.uniqueID}</td>
                    <td data-label="Timestamp">${order.timestamp}</td>
                    <td data-label="Item Name">${order.itemName}</td>
                    <td data-label="Qty">${order.qty}</td>
                    <td data-label="Location">${order.godownLocation}</td>
                    <td data-label="Status">${order.orderStatus}</td>
                    <td data-label="Action" class="action-cell">
                        <button class="update-btn" onclick="event.stopPropagation(); openUpdateModal('${order.uniqueID}')">Update</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        function filterTable() {
            const locationFilter = document.getElementById('locationFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            
            let filteredData = allOrdersData;
            if (locationFilter) {
                filteredData = filteredData.filter(order => order.godownLocation === locationFilter);
            }
            if (statusFilter) {
                filteredData = filteredData.filter(order => order.orderStatus === statusFilter);
            }
            populateTable(filteredData);
        }
        
        const updateModal = document.getElementById('updateModal');
        const historyModal = document.getElementById('historyModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const closeHistoryModalBtn = document.getElementById('closeHistoryModalBtn');

        closeModalBtn.onclick = () => { updateModal.style.display = 'none'; };
        closeHistoryModalBtn.onclick = () => { historyModal.style.display = 'none'; };
        window.addEventListener('click', (event) => { 
            if (event.target == updateModal) updateModal.style.display = 'none';
            if (event.target == historyModal) historyModal.style.display = 'none';
        });

        function openUpdateModal(uniqueID) {
            event.stopPropagation();
            document.getElementById('updateOrderForm').reset();
            resetModalFields();
            document.getElementById('updateUniqueID').value = uniqueID;
            document.getElementById('orderIdDisplay').innerText = `Order ID: ${uniqueID}`;
            updateModal.style.display = 'flex';
        }
        
        function openHistoryModal(uniqueID) {
            const container = document.getElementById('historyTimelineContainer');
            document.getElementById('historyOrderIdDisplay').innerText = `Tracking ID: ${uniqueID}`;
            container.innerHTML = '<p>Loading history...</p>';
            historyModal.style.display = 'flex';

            fetch(`${WEB_APP_URL}?action=getOrderHistory&orderId=${uniqueID}`)
                .then(response => response.json())
                .then(result => {
                    if (result.status === 'success') {
                        populateHistoryModal(result.data, uniqueID);
                    } else {
                        container.innerHTML = `<p>Error fetching history: ${result.message}</p>`;
                    }
                }).catch(err => {
                    console.error("History Fetch Error:", err);
                    container.innerHTML = '<p>Could not fetch history.</p>';
                });
        }

        function populateHistoryModal(historyData, uniqueID) {
            const container = document.getElementById('historyTimelineContainer');
            if (historyData.length === 0) {
                container.innerHTML = "<p>No history found for this order.</p>";
                return;
            }

            let timelineHTML = '<ul class="timeline">';
            const mainOrder = allOrdersData.find(o => o.uniqueID === uniqueID);
            if (mainOrder) {
                timelineHTML += `
                    <li class="timeline-item">
                        <div class="timeline-dot"></div>
                        <div class="timeline-date">${new Date(mainOrder.timestamp).toLocaleString()}</div>
                        <div class="timeline-content"><h4>Order Created</h4><p>Request submitted by: ${mainOrder.user}</p></div>
                    </li>`;
            }

            historyData.forEach(item => {
                let remarkHTML = item.remark ? `<p><strong>Remark:</strong> ${item.remark}</p>` : '';
                let fileHTML = item.fileLink ? `<p><a href="${item.fileLink}" target="_blank">View Invoice</a></p>` : '';
                timelineHTML += `
                    <li class="timeline-item">
                        <div class="timeline-dot"></div>
                        <div class="timeline-date">${new Date(item.timestamp).toLocaleString()}</div>
                        <div class="timeline-content">
                            <h4>Status changed to: ${item.newStatus}</h4>
                            <p>Updated by: ${item.updatedBy}</p>
                            ${remarkHTML}${fileHTML}
                        </div>
                    </li>`;
            });

            timelineHTML += '</ul>';
            container.innerHTML = timelineHTML;
        }

        document.getElementById('newStatus').addEventListener('change', function() {
            const status = this.value;
            const remarkGroup = document.getElementById('remarkGroup');
            const remarkTextarea = document.getElementById('remark');
            const invoiceGroup = document.getElementById('invoiceGroup');
            const invoiceFile = document.getElementById('invoiceFile');
            
            resetModalFields();

            switch(status) {
                case 'Dispatch':
                    remarkGroup.classList.remove('hidden');
                    invoiceGroup.classList.remove('hidden');
                    invoiceFile.required = true;
                    remarkTextarea.required = false;
                    break;
                case 'Cancel': case 'Reject':
                    remarkGroup.classList.remove('hidden');
                    remarkTextarea.required = true;
                    remarkTextarea.placeholder = "Remark is mandatory for this status.";
                    break;
                case 'Order Received': case 'Delivered':
                    remarkGroup.classList.remove('hidden');
                    remarkTextarea.required = false;
                    remarkTextarea.placeholder = "";
                    break;
            }
        });
        
        function resetModalFields() {
            document.getElementById('remarkGroup').classList.add('hidden');
            document.getElementById('invoiceGroup').classList.add('hidden');
            document.getElementById('remark').required = false;
            document.getElementById('invoiceFile').required = false;
        }
        
        document.getElementById('updateOrderForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const invoiceFile = document.getElementById('invoiceFile').files[0];

            if (invoiceFile) {
                const reader = new FileReader();
                reader.readAsDataURL(invoiceFile);
                reader.onload = () => submitUpdate(reader.result, invoiceFile.name, invoiceFile.type);
                reader.onerror = (error) => alert('Error reading file: ' + error);
            } else {
                submitUpdate(null, null, null);
            }
        });

        function submitUpdate(fileData, fileName, fileType) {
            const submitButton = document.getElementById('updateOrderForm').querySelector('.submit-btn');
            submitButton.disabled = true;
            submitButton.innerText = 'Updating...';

            const updateData = {
                uniqueID: document.getElementById('updateUniqueID').value,
                newStatus: document.getElementById('newStatus').value,
                remark: document.getElementById('remark').value,
                updatedBy: sessionStorage.getItem("userEmail"),
                fileData: fileData,
                fileName: fileName,
                fileType: fileType
            };
            
            fetch(WEB_APP_URL, {
                method: 'POST',
                body: JSON.stringify({ action: "updateOrder", updateData: updateData }),
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            })
            .then(response => response.json())
            .then(result => {
                alert(result.message);
                if (result.status === 'success') {
                    updateModal.style.display = 'none';
                    fetchAllOrders();
                }
            })
            .catch(err => alert("An error occurred: " + err))
            .finally(() => {
                submitButton.disabled = false;
                submitButton.innerText = 'Update Status';
            });
        }
    </script>
</body>
</html>
