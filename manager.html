<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manager Dashboard</title>
    <!-- Add Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px;
            color: #333;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding: 0 10px;
        }
        .header h1 {
            font-size: 1.8rem;
            font-weight: 600;
        }

        .top-filters {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
            align-items: center;
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .top-filters label { font-weight: 500; }
        .top-filters select {
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ddd;
            background-color: #f9f9f9;
        }

        /* --- NEW: Dashboard Grid Layout --- */
        .location-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 25px;
        }

        /* --- NEW: Card Styling --- */
        .location-card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .location-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }

        .card-header {
            padding: 20px;
            background-color: #343a40;
            color: white;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .card-header i { font-size: 1.5rem; }
        .card-header h3 { margin: 0; font-size: 1.2rem; font-weight: 600; }

        .card-summary {
            display: flex;
            justify-content: space-around;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        .summary-item { text-align: center; }
        .summary-item .count { font-size: 1.5rem; font-weight: 600; }
        .summary-item .label { font-size: 0.8rem; color: #6c757d; }

        .order-list {
            list-style: none;
            padding: 0;
            margin: 0;
            flex-grow: 1; /* Allows list to take remaining space */
        }
        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .order-item:last-child { border-bottom: none; }
        .order-item:hover { background-color: #f8f9fa; }
        .order-info .id { font-weight: 600; font-size: 0.9rem; }
        .order-info .item { color: #555; font-size: 0.85rem; }
        .order-status {
            padding: 5px 10px;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 500;
            color: white;
        }
        /* Color-coded status badges */
        .status-New { background-color: #007bff; }
        .status-Order.Received { background-color: #6f42c1; }
        .status-Dispatch { background-color: #fd7e14; }
        .status-Delivered { background-color: #28a745; }
        .status-Cancel, .status-Reject { background-color: #dc3545; }

        /* --- History Modal Styles (Unchanged) --- */
        .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:none;justify-content:center;align-items:center;z-index:1000}
        .modal-content{background:white;padding:30px;border-radius:8px;width:90%;max-width:600px;position:relative}
        .close-btn{position:absolute;top:15px;right:15px;font-size:24px;cursor:pointer;border:none;background:none}
        #historyOrderIdDisplay{font-weight:600;background-color:#e9ecef;padding:10px;border-radius:4px;margin-bottom:20px}
        .timeline { list-style: none; padding: 0; position: relative; }
        .timeline::before { content: ''; position: absolute; top: 0; bottom: 0; left: 10px; width: 3px; background-color: #e9ecef; }
        .timeline-item { margin-bottom: 20px; padding-left: 30px; position: relative; }
        .timeline-dot { position: absolute; left: 0; top: 4px; width: 22px; height: 22px; border-radius: 50%; background-color: #007bff; border: 3px solid white; }
        .timeline-item:first-child .timeline-dot { background-color: #6c757d; }
        .timeline-item:last-child .timeline-dot { background-color: #28a745; }
        .timeline-date { font-size: 13px; color: #6c757d; margin-bottom: 5px; }
        .timeline-content { background-color: #f8f9fa; padding: 15px; border-radius: 6px; }
    </style>
</head>
<body>

    <div class="header"><h1>Manager Dashboard</h1></div>

    <div class="top-filters">
        <label for="statusFilter">Filter by Status:</label>
        <select id="statusFilter" onchange="renderDashboard()">
            <option value="">All Statuses</option>
            <option value="New">New</option>
            <option value="Order Received">Order Received</option>
            <option value="Dispatch">Dispatch</option>
            <option value="Delivered">Delivered</option>
            <option value="Cancel">Cancel</option>
            <option value="Reject">Reject</option>
        </select>
    </div>

    <!-- The grid where location cards will be placed -->
    <div class="location-grid" id="locationGrid"></div>
    
    <!-- History/Tracking Modal (HTML is unchanged) -->
    <div class="modal-overlay" id="historyModal">
        <div class="modal-content">
            <button class="close-btn" id="closeHistoryModalBtn">&times;</button>
            <h2>Order History</h2>
            <div id="historyOrderIdDisplay"></div>
            <div id="historyTimelineContainer"></div>
        </div>
    </div>

    <script>
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbz4rczYSc6x5iWNflvYVWEv6qVWgkFQeTOKCbWekhllKDh6N_xWVeRGP_-CpQAQYSHRXw/exec';
        let allOrdersData = [];

        document.addEventListener('DOMContentLoaded', function() {
            if (sessionStorage.getItem("userType") !== "Manager") {
                window.location.href = "Index.html";
                return;
            }
            fetchAllOrders();
        });

        function fetchAllOrders() {
            fetch(`${WEB_APP_URL}?action=getAllOrders`)
                .then(response => response.json())
                .then(result => {
                    if (result.status === 'success') {
                        allOrdersData = result.data;
                        renderDashboard(); // Render the new dashboard view
                    } else {
                        alert('Error fetching orders: ' + result.message);
                    }
                }).catch(err => console.error("Fetch Error:", err));
        }

        // --- NEW: Renders the entire card-based dashboard ---
        function renderDashboard() {
            const statusFilter = document.getElementById('statusFilter').value;
            const grid = document.getElementById('locationGrid');
            grid.innerHTML = ''; // Clear previous view

            // 1. Apply status filter first
            let filteredData = allOrdersData;
            if (statusFilter) {
                filteredData = filteredData.filter(order => order.orderStatus === statusFilter);
            }

            // 2. Group the filtered orders by location
            const ordersByLocation = filteredData.reduce((acc, order) => {
                const location = order.godownLocation;
                if (!acc[location]) {
                    acc[location] = [];
                }
                acc[location].push(order);
                return acc;
            }, {});

            // 3. Create a card for each location
            for (const location in ordersByLocation) {
                const orders = ordersByLocation[location];
                const card = document.createElement('div');
                card.className = 'location-card';

                // Calculate summary stats for this location
                const total = orders.length;
                const newCount = orders.filter(o => o.orderStatus === 'New').length;
                const dispatchedCount = orders.filter(o => o.orderStatus === 'Dispatch').length;

                // Create the list of orders for the card body
                let orderListHTML = '<ul class="order-list">';
                orders.forEach(order => {
                    // Sanitize class name for statuses like "Order Received"
                    const statusClass = order.orderStatus.replace(/\s+/g, '.');
                    orderListHTML += `
                        <li class="order-item" onclick="openHistoryModal('${order.uniqueID}')">
                            <div class="order-info">
                                <div class="id">${order.uniqueID}</div>
                                <div class="item">${order.itemName}</div>
                            </div>
                            <span class="order-status status-${statusClass}">${order.orderStatus}</span>
                        </li>`;
                });
                orderListHTML += '</ul>';

                // Assemble the full card HTML
                card.innerHTML = `
                    <div class="card-header">
                        <i class="fa-solid fa-warehouse"></i>
                        <h3>${location}</h3>
                    </div>
                    <div class="card-summary">
                        <div class="summary-item"><div class="count">${total}</div><div class="label">Total Orders</div></div>
                        <div class="summary-item"><div class="count">${newCount}</div><div class="label">New</div></div>
                        <div class="summary-item"><div class="count">${dispatchedCount}</div><div class="label">Dispatched</div></div>
                    </div>
                    ${orderListHTML}
                `;
                grid.appendChild(card);
            }
        }
        
        // --- History Modal functions are identical to Godown.html ---
        const historyModal = document.getElementById('historyModal');
        const closeHistoryModalBtn = document.getElementById('closeHistoryModalBtn');
        closeHistoryModalBtn.onclick = () => { historyModal.style.display = 'none'; };
        window.onclick = (event) => { 
            if (event.target == historyModal) { historyModal.style.display = 'none'; }
        };

        function openHistoryModal(uniqueID) {
            // Your existing openHistoryModal and populateHistoryModal functions are perfect and remain here
            const container=document.getElementById('historyTimelineContainer');document.getElementById('historyOrderIdDisplay').innerText=`Tracking ID: ${uniqueID}`;container.innerHTML='<p>Loading history...</p>';historyModal.style.display='flex';fetch(`${WEB_APP_URL}?action=getOrderHistory&orderId=${uniqueID}`).then(response=>response.json()).then(result=>{if(result.status==='success'){populateHistoryModal(result.data,uniqueID)}else{container.innerHTML=`<p>Error fetching history: ${result.message}</p>`}}).catch(err=>{console.error("History Fetch Error:",err);container.innerHTML='<p>Could not fetch history.</p>'})}
        function populateHistoryModal(historyData,uniqueID){const container=document.getElementById('historyTimelineContainer');if(historyData.length===0){container.innerHTML="<p>No history found for this order.</p>";return}let timelineHTML='<ul class="timeline">';const mainOrder=allOrdersData.find(o=>o.uniqueID===uniqueID);if(mainOrder){timelineHTML+=`<li class="timeline-item"><div class="timeline-dot"></div><div class="timeline-date">${new Date(mainOrder.timestamp).toLocaleString()}</div><div class="timeline-content"><h4>Order Created</h4><p>Request submitted by: ${mainOrder.user}</p></div></li>`}historyData.forEach(item=>{let remarkHTML=item.remark?`<p><strong>Remark:</strong> ${item.remark}</p>`:'';let fileHTML=item.fileLink?`<p><a href="${item.fileLink}" target="_blank">View Invoice</a></p>`:'';timelineHTML+=`<li class="timeline-item"><div class="timeline-dot"></div><div class="timeline-date">${new Date(item.timestamp).toLocaleString()}</div><div class="timeline-content"><h4>Status changed to: ${item.newStatus}</h4><p>Updated by: ${item.updatedBy}</p>${remarkHTML}${fileHTML}</div></li>`});timelineHTML+='</ul>';container.innerHTML=timelineHTML}
    </script>
</body>
</html>